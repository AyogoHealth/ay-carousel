var AyCarousel = (function () {
    function AyCarousel(carousel) {
        var _this = this;
        this.startX = 0;
        this.startY = 0;
        this.callbacks = {};
        this.index = 0;
        this.SNAPPINESS = 40;
        if (carousel) {
            this.carousel = carousel;
            this.carousel.addEventListener('touchstart', function (e) { return _this.ondragstart(e); });
            this.carousel.addEventListener('mousedown', function (e) { return _this.ondragstart(e); });
            this.cards = this.carousel.children;
            this.cardWidth = this.cards[0].offsetWidth + this.cards[0].offsetLeft;
            this.carousel.addEventListener('transitionend', function () {
                _this.rescale();
            });
            this.rescale();
            document.getElementById('right').addEventListener('click', this.snap.bind(this, undefined, 'right'));
            document.getElementById('left').addEventListener('click', this.snap.bind(this, undefined, 'left'));
        }
    }
    AyCarousel.prototype.ondragstart = function (e) {
        var _this = this;
        var touches = e.touches ? e.touches[0] : e;
        var pageX = touches.pageX, pageY = touches.pageY;
        var boundingRect = this.cards[this.index].getBoundingClientRect();
        this.offset = {
            x: pageX - boundingRect.left,
            y: pageY - boundingRect.top
        };
        this.delta = {};
        this.position = {
            x: this.carousel.offsetLeft,
            y: this.carousel.offsetTop
        };
        var edgeToCardDist = this.cards[this.index].getBoundingClientRect().left;
        this.lastTranslate = this.carousel.getBoundingClientRect().left - edgeToCardDist;
        this.totalMove =
            this.startX = pageX;
        this.startY = pageY;
        this.dragging = undefined;
        this.callbacks.onmove = function (e) { return _this.ondragmove(e); };
        this.callbacks.onend = function (e) { return _this.ondragend(e); };
        this.totalMove = {
            x: 0,
            y: 0
        };
        this.lastPos = {
            x: 0,
            y: 0
        };
        this.carousel.addEventListener('mousemove', this.callbacks.onmove);
        this.carousel.addEventListener('touchmove', this.callbacks.onmove);
        this.carousel.addEventListener('touchend', this.callbacks.onend);
        this.carousel.addEventListener('mouseup', this.callbacks.onend);
        this.carousel.addEventListener('mouseleave', this.callbacks.onend);
    };
    AyCarousel.prototype.ondragmove = function (e) {
        var touches = e.touches ? e.touches[0] : e;
        var pageX = touches.pageX, pageY = touches.pageY;
        var move = {
            x: this.startX - pageX,
            y: this.startY - pageY
        };
        this.totalMove.x += Math.abs(move.x - this.lastPos.x);
        this.totalMove.y += Math.abs(move.y - this.lastPos.y);
        this.lastPos = {
            x: move.x,
            y: move.y
        };
        if (this.totalMove.x < 10 && this.totalMove.y < 10) {
            return;
        }
        if (this.totalMove.x > this.totalMove.y) {
            e.preventDefault();
            this.delta = {
                x: pageX - this.position.x,
                y: pageY - this.position.y
            };
            var currentTranslate = this.delta.x + this.lastTranslate - this.offset.x;
            this.translate(currentTranslate, 0, null);
            var cardMidpoint = (this.cards[this.index].getBoundingClientRect().left + this.cards[this.index].getBoundingClientRect().right) / 2;
            var viewportWidth = window.innerWidth;
            if (cardMidpoint <= 0 + this.SNAPPINESS) {
                this.index = Math.min(this.index + 1, this.cards.length - 1);
            }
            else if (cardMidpoint > viewportWidth - this.SNAPPINESS) {
                this.index = Math.max(this.index - 1, 0);
            }
        }
    };
    AyCarousel.prototype.snap = function (nextIndex, direction) {
        if (direction) {
            direction == 'right' ? nextIndex = this.index + 1 : nextIndex = this.index - 1;
        }
        nextIndex = Math.min(Math.max(nextIndex, 0), this.cards.length - 1);
        this.index = nextIndex;
        var container = this.carousel.parentElement;
        var containerWidth = container.offsetWidth;
        var containerMargin = parseInt(window.getComputedStyle(container).marginLeft, 0);
        var card = this.cards[nextIndex];
        var edgeToCardDist = (containerWidth - card.offsetWidth) / 2;
        var nextOffset = Math.min((card.offsetLeft - edgeToCardDist + containerMargin) * -1, 0);
        var ease = 'cubic-bezier(0.785, 0.135, 0.15, 0.86)';
        this.translate(nextOffset, 250, ease);
    };
    AyCarousel.prototype.ondragend = function (e) {
        this.position = {
            x: e.target.offsetLeft,
            y: e.target.offsetTop
        };
        this.totalMove = {
            x: 0,
            y: 0
        };
        this.carousel.removeEventListener('mousemove', this.callbacks.onmove);
        this.carousel.removeEventListener('touchmove', this.callbacks.onmove);
        this.carousel.removeEventListener('touchend', this.callbacks.onend);
        this.carousel.removeEventListener('mouseup', this.callbacks.onend);
        this.carousel.removeEventListener('mouseleave', this.callbacks.onend);
        this.dragging = undefined;
        this.snap(this.index, undefined);
        this.rescale();
    };
    AyCarousel.prototype.translate = function (x, length, fn) {
        this.carousel.style['transition'] = 'transform';
        this.carousel.style['transitionTimingFunction'] = fn;
        this.carousel.style['transitionDuration'] = length + "ms";
        this.carousel.style['transform'] = "translate3d(" + x + "px,0px,0px)";
        this.rescale();
    };
    AyCarousel.prototype.percentVisible = function (card) {
        var cardRect = card.getBoundingClientRect();
        var cardWidth = card.offsetWidth;
        var frameWidth = window.innerWidth;
        if ((cardRect.left < 0 && cardRect.right < 0) || cardRect.left > frameWidth) {
            return 0;
        }
        else if (cardRect.left < 0) {
            return cardRect.right / cardWidth;
        }
        else if (cardRect.right > frameWidth) {
            return (frameWidth - cardRect.left) / cardWidth;
        }
        else {
            return 1;
        }
    };
    AyCarousel.prototype.rescale = function () {
        var from = Math.max(this.index - 2, 0);
        var to = Math.min(this.index + 2, this.cards.length - 1);
        for (var i = from; i <= to; i++) {
            var scaler = Math.max(this.percentVisible(this.cards[i]), 0.9);
            this.cards[i].style['transform'] = "scale(" + scaler + ")";
            this.cards[i].style['transitionTimingFunction'] = 'ease';
            this.cards[i].style['transitionDuration'] = "250ms";
        }
    };
    return AyCarousel;
}());
new AyCarousel(document.querySelector('#carousel-1'));
new AyCarousel(document.querySelector('#carousel-2'));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7SUFrQkUsb0JBQVksUUFBc0I7UUFBbEMsaUJBbUJDO1FBbENELFdBQU0sR0FBWSxDQUFDLENBQUM7UUFDcEIsV0FBTSxHQUFZLENBQUMsQ0FBQztRQUtwQixjQUFTLEdBQVMsRUFBRSxDQUFDO1FBR3JCLFVBQUssR0FBWSxDQUFDLENBQUM7UUFFVixlQUFVLEdBQVksRUFBRSxDQUFDO1FBS2hDLEVBQUUsQ0FBQSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFDWixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztZQUV6QixJQUFJLENBQUMsUUFBUSxDQUFDLGdCQUFnQixDQUFDLFlBQVksRUFBRSxVQUFBLENBQUMsSUFBSSxPQUFBLEtBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEVBQW5CLENBQW1CLENBQUMsQ0FBQztZQUN2RSxJQUFJLENBQUMsUUFBUSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsRUFBRSxVQUFBLENBQUMsSUFBSSxPQUFBLEtBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEVBQW5CLENBQW1CLENBQUMsQ0FBQztZQUV0RSxJQUFJLENBQUMsS0FBSyxHQUFRLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDO1lBRXpDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUM7WUFFdEUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxlQUFlLEVBQUU7Z0JBQzlDLEtBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNqQixDQUFDLENBQUMsQ0FBQztZQUNILElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUVmLFFBQVEsQ0FBQyxj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bkIsSUFBSSxDQUFDLEtBQUssR0FBRztnQkFDWCxDQUFDLEVBQUUsS0FBSyxHQUFHLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQztnQkFDMUIsQ0FBQyxFQUFFLEtBQUssR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUM7YUFDM0IsQ0FBQztZQUNGLElBQU0sZ0JBQWdCLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQztZQUUzRSxJQUFJLENBQUMsU0FBUyxDQUFDLGdCQUFnQixFQUFFLENBQUMsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUUxQyxJQUFJLFlBQVksR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLHFCQUFxQixFQUFFLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLHFCQUFxQixFQUFFLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3BJLElBQUksYUFBYSxHQUFHLE1BQU0sQ0FBQyxVQUFVLENBQUM7WUFFdEMsRUFBRSxDQUFBLENBQUMsWUFBWSxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztnQkFFdkMsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxHQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzNELENBQUM7WUFBQyxJQUFJLENBQUMsRUFBRSxDQUFBLENBQUMsWUFBWSxHQUFHLGFBQWEsR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUMsQ0FBQztnQkFFekQsSUFBSSxDQUFDLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLEdBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQ3pDLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztJQUVELHlCQUFJLEdBQUosVUFBSyxTQUFTLEVBQUUsU0FBUztRQUN2QixFQUFFLENBQUEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDO1lBQ2IsU0FBUyxJQUFJLE9BQU8sR0FBRyxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssR0FBQyxDQUFDLEdBQUcsU0FBUyxHQUFHLElBQUksQ0FBQyxLQUFLLEdBQUMsQ0FBQyxDQUFDO1FBQzdFLENBQUM7UUFDRCxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQztRQUNwRSxJQUFJLENBQUMsS0FBSyxHQUFHLFNBQVMsQ0FBQztRQUV2QixJQUFNLFNBQVMsR0FBRyxJQUFJLENBQUMsUUFBUSxDQUFDLGFBQWEsQ0FBQztRQUM5QyxJQUFNLGNBQWMsR0FBRyxTQUFTLENBQUMsV0FBVyxDQUFDO1FBQzdDLElBQU0sZUFBZSxHQUFHLFFBQVEsQ0FBQyxNQUFNLENBQUMsZ0JBQWdCLENBQUMsU0FBUyxDQUFDLENBQUMsVUFBVSxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRW5GLElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUM7UUFJbkMsSUFBTSxjQUFjLEdBQUcsQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFDLENBQUMsQ0FBQztRQUk3RCxJQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFDLFVBQVUsR0FBRyxjQUFjLEdBQUcsZUFBZSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFHMUYsSUFBTSxJQUFJLEdBQUcsd0NBQXdDLENBQUM7UUFDdEQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxVQUFVLEVBQUUsR0FBRyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3hDLENBQUM7SUFFRCw4QkFBUyxHQUFULFVBQVUsQ0FBQztRQUNULElBQUksQ0FBQyxRQUFRLEdBQUc7WUFDZCxDQUFDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxVQUFVO1lBQ3RCLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLFNBQVM7U0FDdEIsQ0FBQztRQUVGLElBQUksQ0FBQyxTQUFTLEdBQUc7WUFDZixDQUFDLEVBQUUsQ0FBQztZQUNKLENBQUMsRUFBRSxDQUFDO1NBQ0wsQ0FBQztRQUNGLElBQUksQ0FBQyxRQUFRLENBQUMsbUJBQW1CLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDdEUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQyxXQUFXLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUV0RSxJQUFJLENBQUMsUUFBUSxDQUFDLG1CQUFtQixDQUFDLFVBQVUsRUFBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ25FLElBQUksQ0FBQyxRQUFRLENBQUMsbUJBQW1CLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDbkUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxtQkFBbUIsQ0FBQyxZQUFZLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUV0RSxJQUFJLENBQUMsUUFBUSxHQUFHLFNBQVMsQ0FBQztRQUcxQixJQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsU0FBUyxDQUFDLENBQUM7UUFFakMsSUFBSSxDQUFDLE9BQU8sRUFBRSxDQUFDO0lBQ2pCLENBQUM7SUFFRCw4QkFBUyxHQUFULFVBQVUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxFQUFFO1FBQ3JCLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLFlBQVksQ0FBQyxHQUFHLFdBQVcsQ0FBQztRQUNoRCxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQywwQkFBMEIsQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUNyRCxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxHQUFNLE1BQU0sT0FBSSxDQUFDO1FBQzFELElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxHQUFHLGlCQUFlLENBQUMsZ0JBQWEsQ0FBQztRQUVqRSxJQUFJLENBQUMsT0FBTyxFQUFFLENBQUM7SUFDakIsQ0FBQztJQUVELG1DQUFjLEdBQWQsVUFBZSxJQUFJO1FBQ2pCLElBQUksUUFBUSxHQUFHLElBQUksQ0FBQyxxQkFBcUIsRUFBRSxDQUFDO1FBQzVDLElBQUksU0FBUyxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUM7UUFDakMsSUFBSSxVQUFVLEdBQUcsTUFBTSxDQUFDLFVBQVUsQ0FBQztRQUVuQyxFQUFFLENBQUEsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxJQUFJLFFBQVEsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLElBQUksUUFBUSxDQUFDLElBQUksR0FBRyxVQUFVLENBQUMsQ0FBQyxDQUFDO1lBQzNFLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDWCxDQUFDO1FBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQSxDQUFDLFFBQVEsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUM1QixNQUFNLENBQUMsUUFBUSxDQUFDLEtBQUssR0FBQyxTQUFTLENBQUM7UUFDbEMsQ0FBQztRQUFDLElBQUksQ0FBQyxFQUFFLENBQUEsQ0FBQyxRQUFRLENBQUMsS0FBSyxHQUFHLFVBQVUsQ0FBQyxDQUFDLENBQUM7WUFDdEMsTUFBTSxDQUFDLENBQUMsVUFBVSxHQUFHLFFBQVEsQ0FBQyxJQUFJLENBQUMsR0FBQyxTQUFTLENBQUM7UUFDaEQsQ0FBQztRQUFDLElBQUksQ0FBQyxDQUFDO1lBQ04sTUFBTSxDQUFDLENBQUMsQ0FBQztRQUNYLENBQUM7SUFDSCxDQUFDO0lBRUQsNEJBQU8sR0FBUDtRQUVFLElBQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssR0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUM7UUFDdkMsSUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxHQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sR0FBQyxDQUFDLENBQUMsQ0FBQTtRQUV0RCxHQUFHLENBQUEsQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLEVBQUUsQ0FBQyxJQUFFLEVBQUUsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDO1lBQzdCLElBQUksTUFBTSxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUM7WUFFL0QsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxLQUFLLENBQUMsV0FBVyxDQUFDLEdBQUcsV0FBUyxNQUFNLE1BQUcsQ0FBQztZQUN0RCxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQywwQkFBMEIsQ0FBQyxHQUFHLE1BQU0sQ0FBQztZQUN6RCxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEtBQUssQ0FBQyxvQkFBb0IsQ0FBQyxHQUFHLE9BQU8sQ0FBQztRQUN0RCxDQUFDO0lBQ0gsQ0FBQztJQUNILGlCQUFDO0FBQUQsQ0FBQyxBQTVORCxJQTROQztBQUNELElBQUksVUFBVSxDQUFjLFFBQVEsQ0FBQyxhQUFhLENBQUMsYUFBYSxDQUFDLENBQUMsQ0FBQztBQUNuRSxJQUFJLFVBQVUsQ0FBYyxRQUFRLENBQUMsYUFBYSxDQUFDLGFBQWEsQ0FBQyxDQUFDLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJjbGFzcyBBeUNhcm91c2VsIHtcbiAgZHJhZ2dpbmcgOiBib29sZWFuO1xuICBvZmZzZXQgOiBhbnk7XG4gIHN0YXJ0WCA6IG51bWJlciA9IDA7XG4gIHN0YXJ0WSA6IG51bWJlciA9IDA7XG4gIGRlbHRhIDogYW55O1xuICBwb3NpdGlvbiA6IGFueTtcbiAgY3VycmVudFRyYW5zbGF0ZSA6IG51bWJlcjtcbiAgbGFzdFRyYW5zbGF0ZSA6IG51bWJlcjtcbiAgY2FsbGJhY2tzIDogYW55ID0ge307XG4gIGNhcmRzIDogSFRNTEVsZW1lbnRbXTtcbiAgY2FyZFdpZHRoIDogbnVtYmVyO1xuICBpbmRleCA6IG51bWJlciA9IDA7XG4gIGNhcm91c2VsIDogSFRNTEVsZW1lbnQ7XG4gIHJlYWRvbmx5IFNOQVBQSU5FU1MgOiBudW1iZXIgPSA0MDtcbiAgdG90YWxNb3ZlIDogYW55O1xuICBsYXN0UG9zIDogYW55O1xuXG4gIGNvbnN0cnVjdG9yKGNhcm91c2VsIDogSFRNTEVsZW1lbnQpIHtcbiAgICBpZihjYXJvdXNlbCkge1xuICAgICAgdGhpcy5jYXJvdXNlbCA9IGNhcm91c2VsO1xuICAgICAgXG4gICAgICB0aGlzLmNhcm91c2VsLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoc3RhcnQnLCBlID0+IHRoaXMub25kcmFnc3RhcnQoZSkpO1xuICAgICAgdGhpcy5jYXJvdXNlbC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWRvd24nLCBlID0+IHRoaXMub25kcmFnc3RhcnQoZSkpO1xuXG4gICAgICB0aGlzLmNhcmRzID0gPGFueT50aGlzLmNhcm91c2VsLmNoaWxkcmVuO1xuXG4gICAgICB0aGlzLmNhcmRXaWR0aCA9IHRoaXMuY2FyZHNbMF0ub2Zmc2V0V2lkdGggKyB0aGlzLmNhcmRzWzBdLm9mZnNldExlZnQ7XG5cbiAgICAgIHRoaXMuY2Fyb3VzZWwuYWRkRXZlbnRMaXN0ZW5lcigndHJhbnNpdGlvbmVuZCcsICgpID0+IHtcbiAgICAgICAgdGhpcy5yZXNjYWxlKCk7XG4gICAgICB9KTtcbiAgICAgIHRoaXMucmVzY2FsZSgpO1xuICAgICAgXG4gICAgICBkb2N1bWVudC5nZXRFbGVtZW50QnlJZCgncmlnaHQnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMuc25hcC5iaW5kKHRoaXMsIHVuZGVmaW5lZCwgJ3JpZ2h0JykpO1xuICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ2xlZnQnKS5hZGRFdmVudExpc3RlbmVyKCdjbGljaycsIHRoaXMuc25hcC5iaW5kKHRoaXMsIHVuZGVmaW5lZCwgJ2xlZnQnKSk7IFxuICAgIH0gXG4gIH1cblxuICBvbmRyYWdzdGFydChlKSB7XG4gICAgY29uc3QgdG91Y2hlcyA9ICBlLnRvdWNoZXMgPyBlLnRvdWNoZXNbMF0gOiBlO1xuICAgIGNvbnN0IHtwYWdlWCwgcGFnZVl9ID0gdG91Y2hlcztcblxuICAgIGNvbnN0IGJvdW5kaW5nUmVjdCA9IHRoaXMuY2FyZHNbdGhpcy5pbmRleF0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCk7XG4gICAgdGhpcy5vZmZzZXQgPSB7XG4gICAgICB4OiBwYWdlWCAtIGJvdW5kaW5nUmVjdC5sZWZ0LFxuICAgICAgeTogcGFnZVkgLSBib3VuZGluZ1JlY3QudG9wXG4gICAgfTtcblxuICAgIHRoaXMuZGVsdGEgPSB7fTtcblxuICAgIHRoaXMucG9zaXRpb24gPSB7XG4gICAgICB4OiB0aGlzLmNhcm91c2VsLm9mZnNldExlZnQsXG4gICAgICB5OiB0aGlzLmNhcm91c2VsLm9mZnNldFRvcFxuICAgIH07XG5cbiAgICBsZXQgZWRnZVRvQ2FyZERpc3QgPSB0aGlzLmNhcmRzW3RoaXMuaW5kZXhdLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmxlZnQ7XG4gICAgdGhpcy5sYXN0VHJhbnNsYXRlID0gdGhpcy5jYXJvdXNlbC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5sZWZ0IC0gZWRnZVRvQ2FyZERpc3Q7XG5cbiAgICB0aGlzLnRvdGFsTW92ZSA9IFxuICAgIHRoaXMuc3RhcnRYID0gcGFnZVg7XG4gICAgdGhpcy5zdGFydFkgPSBwYWdlWTtcblxuICAgIHRoaXMuZHJhZ2dpbmcgPSB1bmRlZmluZWQ7XG5cbiAgICB0aGlzLmNhbGxiYWNrcy5vbm1vdmUgPSBlID0+IHRoaXMub25kcmFnbW92ZShlKTtcbiAgICB0aGlzLmNhbGxiYWNrcy5vbmVuZCA9IGUgPT4gdGhpcy5vbmRyYWdlbmQoZSk7XG5cbiAgICB0aGlzLnRvdGFsTW92ZSA9IHtcbiAgICAgIHg6IDAsXG4gICAgICB5OiAwXG4gICAgfVxuXG4gICAgdGhpcy5sYXN0UG9zID0ge1xuICAgICAgeDogMCxcbiAgICAgIHk6IDBcbiAgICB9XG4gICAgXG4gICAgdGhpcy5jYXJvdXNlbC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZW1vdmUnLCB0aGlzLmNhbGxiYWNrcy5vbm1vdmUpO1xuICAgIHRoaXMuY2Fyb3VzZWwuYWRkRXZlbnRMaXN0ZW5lcigndG91Y2htb3ZlJywgdGhpcy5jYWxsYmFja3Mub25tb3ZlKTtcbiAgICBcbiAgICB0aGlzLmNhcm91c2VsLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNoZW5kJywgdGhpcy5jYWxsYmFja3Mub25lbmQpO1xuICAgIHRoaXMuY2Fyb3VzZWwuYWRkRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHRoaXMuY2FsbGJhY2tzLm9uZW5kKTtcbiAgICB0aGlzLmNhcm91c2VsLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCB0aGlzLmNhbGxiYWNrcy5vbmVuZCk7XG4gIH1cblxuICBvbmRyYWdtb3ZlKGUpIHtcbiAgICBjb25zdCB0b3VjaGVzID0gIGUudG91Y2hlcyA/IGUudG91Y2hlc1swXSA6IGU7XG4gICAgY29uc3Qge3BhZ2VYLCBwYWdlWX0gPSB0b3VjaGVzO1xuXG4gICAgY29uc3QgbW92ZSA9IHtcbiAgICAgIHg6IHRoaXMuc3RhcnRYIC0gcGFnZVgsXG4gICAgICB5OiB0aGlzLnN0YXJ0WSAtIHBhZ2VZXG4gICAgfVxuXG4gICAgLy8gS2VlcCB0cmFjayBvZiB0aGUgdG90YWwgZGlzdGFuY2UgbW92ZWQgcmlnaHQvbGVmdCBpbiB0aGUgbW92ZVxuICAgIHRoaXMudG90YWxNb3ZlLnggKz0gTWF0aC5hYnMobW92ZS54IC0gdGhpcy5sYXN0UG9zLngpO1xuICAgIHRoaXMudG90YWxNb3ZlLnkgKz0gTWF0aC5hYnMobW92ZS55IC0gdGhpcy5sYXN0UG9zLnkpO1xuICAgIFxuICAgIHRoaXMubGFzdFBvcyA9IHtcbiAgICAgIHg6IG1vdmUueCxcbiAgICAgIHk6IG1vdmUueVxuICAgIH07XG5cbiAgICBpZih0aGlzLnRvdGFsTW92ZS54IDwgMTAgJiYgdGhpcy50b3RhbE1vdmUueSA8IDEwKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgaWYodGhpcy50b3RhbE1vdmUueCA+IHRoaXMudG90YWxNb3ZlLnkpIHtcbiAgICAgIGUucHJldmVudERlZmF1bHQoKTtcbiAgICAgIHRoaXMuZGVsdGEgPSB7XG4gICAgICAgIHg6IHBhZ2VYIC0gdGhpcy5wb3NpdGlvbi54LFxuICAgICAgICB5OiBwYWdlWSAtIHRoaXMucG9zaXRpb24ueVxuICAgICAgfTtcbiAgICAgIGNvbnN0IGN1cnJlbnRUcmFuc2xhdGUgPSB0aGlzLmRlbHRhLnggKyB0aGlzLmxhc3RUcmFuc2xhdGUgLSB0aGlzLm9mZnNldC54O1xuXG4gICAgICB0aGlzLnRyYW5zbGF0ZShjdXJyZW50VHJhbnNsYXRlLCAwLCBudWxsKTtcblxuICAgICAgbGV0IGNhcmRNaWRwb2ludCA9ICh0aGlzLmNhcmRzW3RoaXMuaW5kZXhdLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLmxlZnQgKyB0aGlzLmNhcmRzW3RoaXMuaW5kZXhdLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpLnJpZ2h0KSAvIDI7XG4gICAgICBsZXQgdmlld3BvcnRXaWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoO1xuXG4gICAgICBpZihjYXJkTWlkcG9pbnQgPD0gMCArIHRoaXMuU05BUFBJTkVTUykge1xuICAgICAgICAvLyBJZiBjYXJkIG1pZHBvaW50IGlzIGNsb3NlIGVub3VnaCB0byBsZWZ0IGVkZ2UsIGRlY3JlbWVudCBpbmRleFxuICAgICAgICB0aGlzLmluZGV4ID0gTWF0aC5taW4odGhpcy5pbmRleCsxLCB0aGlzLmNhcmRzLmxlbmd0aC0xKTtcbiAgICAgIH0gZWxzZSBpZihjYXJkTWlkcG9pbnQgPiB2aWV3cG9ydFdpZHRoIC0gdGhpcy5TTkFQUElORVNTKSB7XG4gICAgICAgIC8vIElmIGNhcmQgbWlkcG9pbnQgaXMgY2xvc2UgZW5vdWdoIHRvIHJpZ2h0IGVkZ2UsIGluY3JlbWVudCBpbmRleFxuICAgICAgICB0aGlzLmluZGV4ID0gTWF0aC5tYXgodGhpcy5pbmRleC0xLCAwKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBzbmFwKG5leHRJbmRleCwgZGlyZWN0aW9uKSB7XG4gICAgaWYoZGlyZWN0aW9uKSB7XG4gICAgICBkaXJlY3Rpb24gPT0gJ3JpZ2h0JyA/IG5leHRJbmRleCA9IHRoaXMuaW5kZXgrMSA6IG5leHRJbmRleCA9IHRoaXMuaW5kZXgtMTtcbiAgICB9XG4gICAgbmV4dEluZGV4ID0gTWF0aC5taW4oTWF0aC5tYXgobmV4dEluZGV4LCAwKSwgdGhpcy5jYXJkcy5sZW5ndGggLSAxKTtcbiAgICB0aGlzLmluZGV4ID0gbmV4dEluZGV4O1xuXG4gICAgY29uc3QgY29udGFpbmVyID0gdGhpcy5jYXJvdXNlbC5wYXJlbnRFbGVtZW50O1xuICAgIGNvbnN0IGNvbnRhaW5lcldpZHRoID0gY29udGFpbmVyLm9mZnNldFdpZHRoO1xuICAgIGNvbnN0IGNvbnRhaW5lck1hcmdpbiA9IHBhcnNlSW50KHdpbmRvdy5nZXRDb21wdXRlZFN0eWxlKGNvbnRhaW5lcikubWFyZ2luTGVmdCwgMCk7XG4gIFxuICAgIGNvbnN0IGNhcmQgPSB0aGlzLmNhcmRzW25leHRJbmRleF07XG5cbiAgICAvLyBXaWR0aCBvZiBjb250YWluZXIgLSBXaWR0aCBvZiBjYXJkID0gQWxsIHRoZSBleHRyYSBzcGFjZVxuICAgIC8vIERpdmlkZSB0aGlzIGJ5IDIgdG8gZ2V0IGRlc2lyZWQgZGlzdGFuY2UgZnJvbSBlZGdlIG9uIGVpdGhlciBzaWRlIG9mIGNhcmRcbiAgICBjb25zdCBlZGdlVG9DYXJkRGlzdCA9IChjb250YWluZXJXaWR0aCAtIGNhcmQub2Zmc2V0V2lkdGgpLzI7XG4gICAgXG4gICAgLy8gVHJhbnNsYXRpbmcgdG8gdGhlIGxlZnQgb2YgdGhlIGRlc2lyZWQgY2FyZCwgbWludXMgb3VyIGRlc2lyZWQgZWRnZSBkaXN0XG4gICAgLy8gTXVsdGlwbGllZCBieSAtMSBiZWNhdXNlIHdlIGFyZSB0cmFuc2xhdGluZyB0byB0aGUgcmlnaHRcbiAgICBjb25zdCBuZXh0T2Zmc2V0ID0gTWF0aC5taW4oKGNhcmQub2Zmc2V0TGVmdCAtIGVkZ2VUb0NhcmREaXN0ICsgY29udGFpbmVyTWFyZ2luKSAqIC0xLCAwKTtcblxuICAgIC8vIGh0dHA6Ly9lYXNpbmdzLm5ldC8jZWFzZUluT3V0Q2lyY1xuICAgIGNvbnN0IGVhc2UgPSAnY3ViaWMtYmV6aWVyKDAuNzg1LCAwLjEzNSwgMC4xNSwgMC44NiknO1xuICAgIHRoaXMudHJhbnNsYXRlKG5leHRPZmZzZXQsIDI1MCwgZWFzZSk7XG4gIH1cblxuICBvbmRyYWdlbmQoZSkge1xuICAgIHRoaXMucG9zaXRpb24gPSB7XG4gICAgICB4OiBlLnRhcmdldC5vZmZzZXRMZWZ0LFxuICAgICAgeTogZS50YXJnZXQub2Zmc2V0VG9wXG4gICAgfTtcblxuICAgIHRoaXMudG90YWxNb3ZlID0ge1xuICAgICAgeDogMCxcbiAgICAgIHk6IDBcbiAgICB9O1xuICAgIHRoaXMuY2Fyb3VzZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5jYWxsYmFja3Mub25tb3ZlKTtcbiAgICB0aGlzLmNhcm91c2VsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHRoaXMuY2FsbGJhY2tzLm9ubW92ZSk7XG4gICAgXG4gICAgdGhpcy5jYXJvdXNlbC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsdGhpcy5jYWxsYmFja3Mub25lbmQpO1xuICAgIHRoaXMuY2Fyb3VzZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcignbW91c2V1cCcsIHRoaXMuY2FsbGJhY2tzLm9uZW5kKTtcbiAgICB0aGlzLmNhcm91c2VsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbGVhdmUnLCB0aGlzLmNhbGxiYWNrcy5vbmVuZCk7XG5cbiAgICB0aGlzLmRyYWdnaW5nID0gdW5kZWZpbmVkO1xuXG4gICAgLy8gU25hcCB0byBpbmRleCwgd2hpY2ggaGFzIGJlZW4gc2V0IHRvIHRoZSBuZWFyZXN0IGNhcmRcbiAgICB0aGlzLnNuYXAodGhpcy5pbmRleCwgdW5kZWZpbmVkKTtcblxuICAgIHRoaXMucmVzY2FsZSgpO1xuICB9XG5cbiAgdHJhbnNsYXRlKHgsIGxlbmd0aCwgZm4pIHtcbiAgICB0aGlzLmNhcm91c2VsLnN0eWxlWyd0cmFuc2l0aW9uJ10gPSAndHJhbnNmb3JtJztcbiAgICB0aGlzLmNhcm91c2VsLnN0eWxlWyd0cmFuc2l0aW9uVGltaW5nRnVuY3Rpb24nXSA9IGZuO1xuICAgIHRoaXMuY2Fyb3VzZWwuc3R5bGVbJ3RyYW5zaXRpb25EdXJhdGlvbiddID0gYCR7bGVuZ3RofW1zYDtcbiAgICB0aGlzLmNhcm91c2VsLnN0eWxlWyd0cmFuc2Zvcm0nXSA9IGB0cmFuc2xhdGUzZCgke3h9cHgsMHB4LDBweClgO1xuXG4gICAgdGhpcy5yZXNjYWxlKCk7XG4gIH1cblxuICBwZXJjZW50VmlzaWJsZShjYXJkKSB7XG4gICAgbGV0IGNhcmRSZWN0ID0gY2FyZC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICBsZXQgY2FyZFdpZHRoID0gY2FyZC5vZmZzZXRXaWR0aDtcbiAgICBsZXQgZnJhbWVXaWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoO1xuXG4gICAgaWYoKGNhcmRSZWN0LmxlZnQgPCAwICYmIGNhcmRSZWN0LnJpZ2h0IDwgMCkgfHwgY2FyZFJlY3QubGVmdCA+IGZyYW1lV2lkdGgpIHtcbiAgICAgIHJldHVybiAwO1xuICAgIH0gZWxzZSBpZihjYXJkUmVjdC5sZWZ0IDwgMCkge1xuICAgICAgcmV0dXJuIGNhcmRSZWN0LnJpZ2h0L2NhcmRXaWR0aDtcbiAgICB9IGVsc2UgaWYoY2FyZFJlY3QucmlnaHQgPiBmcmFtZVdpZHRoKSB7XG4gICAgICByZXR1cm4gKGZyYW1lV2lkdGggLSBjYXJkUmVjdC5sZWZ0KS9jYXJkV2lkdGg7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiAxO1xuICAgIH1cbiAgfVxuXG4gIHJlc2NhbGUoKSB7XG4gICAgLy8gUmVzY2FsZSBjdXJyZW50IGNhcmQgYW5kIDIgY2FyZHMgaW4gZWl0aGVyIGRpcmVjdGlvblxuICAgIGNvbnN0IGZyb20gPSBNYXRoLm1heCh0aGlzLmluZGV4LTIgLDApO1xuICAgIGNvbnN0IHRvID0gTWF0aC5taW4odGhpcy5pbmRleCsyLCB0aGlzLmNhcmRzLmxlbmd0aC0xKVxuXG4gICAgZm9yKGxldCBpID0gZnJvbTsgaTw9dG87IGkrKykge1xuICAgICAgbGV0IHNjYWxlciA9IE1hdGgubWF4KHRoaXMucGVyY2VudFZpc2libGUodGhpcy5jYXJkc1tpXSksIDAuOSk7XG5cbiAgICAgIHRoaXMuY2FyZHNbaV0uc3R5bGVbJ3RyYW5zZm9ybSddID0gYHNjYWxlKCR7c2NhbGVyfSlgO1xuICAgICAgdGhpcy5jYXJkc1tpXS5zdHlsZVsndHJhbnNpdGlvblRpbWluZ0Z1bmN0aW9uJ10gPSAnZWFzZSc7XG4gICAgICB0aGlzLmNhcmRzW2ldLnN0eWxlWyd0cmFuc2l0aW9uRHVyYXRpb24nXSA9IGAyNTBtc2A7XG4gICAgfVxuICB9XG59XG5uZXcgQXlDYXJvdXNlbCg8SFRNTEVsZW1lbnQ+ZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2Nhcm91c2VsLTEnKSk7XG5uZXcgQXlDYXJvdXNlbCg8SFRNTEVsZW1lbnQ+ZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2Nhcm91c2VsLTInKSk7XG4iXX0=