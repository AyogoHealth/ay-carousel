var AyCarousel = (function () {
    function AyCarousel(carousel) {
        var _this = this;
        this.startX = 0;
        this.startY = 0;
        this.callbacks = {};
        this.index = 0;
        this.SNAPPINESS = 40;
        if (carousel) {
            this.carousel = carousel;
            this.carousel.addEventListener('touchstart', function (e) { return _this.ondragstart(e); });
            this.carousel.addEventListener('mousedown', function (e) { return _this.ondragstart(e); });
            this.cards = this.carousel.children;
            this.cardWidth = this.cards[0].offsetWidth + this.cards[0].offsetLeft;
            this.carousel.addEventListener('transitionend', function () {
                _this.rescale();
            });
            this.rescale();
            document.getElementById('right').addEventListener('click', this.snap.bind(this, undefined, 'right'));
            document.getElementById('left').addEventListener('click', this.snap.bind(this, undefined, 'left'));
        }
    }
    AyCarousel.prototype.ondragstart = function (e) {
        var _this = this;
        var touches = e.touches ? e.touches[0] : e;
        var pageX = touches.pageX, pageY = touches.pageY;
        var boundingRect = this.cards[this.index].getBoundingClientRect();
        this.offset = {
            x: pageX - boundingRect.left,
            y: pageY - boundingRect.top
        };
        this.delta = {};
        this.position = {
            x: this.carousel.offsetLeft,
            y: this.carousel.offsetTop
        };
        var edgeToCardDist = this.cards[this.index].getBoundingClientRect().left;
        this.lastTranslate = this.carousel.getBoundingClientRect().left - edgeToCardDist;
        this.totalMove =
            this.startX = pageX;
        this.startY = pageY;
        this.dragging = undefined;
        this.callbacks.onmove = function (e) { return _this.ondragmove(e); };
        this.callbacks.onend = function (e) { return _this.ondragend(e); };
        this.totalMove = {
            x: 0,
            y: 0
        };
        this.lastPos = {
            x: 0,
            y: 0
        };
        this.carousel.addEventListener('mousemove', this.callbacks.onmove);
        this.carousel.addEventListener('touchmove', this.callbacks.onmove);
        this.carousel.addEventListener('touchend', this.callbacks.onend);
        this.carousel.addEventListener('mouseup', this.callbacks.onend);
        this.carousel.addEventListener('mouseleave', this.callbacks.onend);
    };
    AyCarousel.prototype.ondragmove = function (e) {
        var touches = e.touches ? e.touches[0] : e;
        var pageX = touches.pageX, pageY = touches.pageY;
        console.log(e);
        var move = {
            x: this.startX - pageX,
            y: this.startY - pageY
        };
        this.totalMove.x += Math.abs(move.x - this.lastPos.x);
        this.totalMove.y += Math.abs(move.y - this.lastPos.y);
        this.lastPos = {
            x: move.x,
            y: move.y
        };
        if (this.totalMove.x < 10 && this.totalMove.y < 10) {
            return;
        }
        if (this.totalMove.x > this.totalMove.y) {
            e.preventDefault();
            this.delta = {
                x: pageX - this.position.x,
                y: pageY - this.position.y
            };
            var currentTranslate = this.delta.x + this.lastTranslate - this.offset.x;
            this.translate(currentTranslate, 0, null);
            var cardMidpoint = (this.cards[this.index].getBoundingClientRect().left + this.cards[this.index].getBoundingClientRect().right) / 2;
            var viewportWidth = window.innerWidth;
            if (cardMidpoint <= 0 + this.SNAPPINESS) {
                this.index = Math.min(this.index + 1, this.cards.length - 1);
            }
            else if (cardMidpoint > viewportWidth - this.SNAPPINESS) {
                this.index = Math.max(this.index - 1, 0);
            }
        }
    };
    AyCarousel.prototype.snap = function (nextIndex, direction) {
        if (direction) {
            direction == 'right' ? nextIndex = this.index + 1 : nextIndex = this.index - 1;
        }
        nextIndex = Math.min(Math.max(nextIndex, 0), this.cards.length - 1);
        this.index = nextIndex;
        var container = this.carousel.parentElement;
        var containerWidth = container.offsetWidth;
        var containerMargin = parseInt(window.getComputedStyle(container).marginLeft, 0);
        var card = this.cards[nextIndex];
        var edgeToCardDist = (containerWidth - card.offsetWidth) / 2;
        var nextOffset = Math.min((card.offsetLeft - edgeToCardDist + containerMargin) * -1, 0);
        var ease = 'cubic-bezier(0.785, 0.135, 0.15, 0.86)';
        this.translate(nextOffset, 250, ease);
    };
    AyCarousel.prototype.ondragend = function (e) {
        this.position = {
            x: e.target.offsetLeft,
            y: e.target.offsetTop
        };
        this.totalMove = {
            x: 0,
            y: 0
        };
        this.carousel.removeEventListener('mousemove', this.callbacks.onmove);
        this.carousel.removeEventListener('touchmove', this.callbacks.onmove);
        this.carousel.removeEventListener('touchend', this.callbacks.onend);
        this.carousel.removeEventListener('mouseup', this.callbacks.onend);
        this.carousel.removeEventListener('mouseleave', this.callbacks.onend);
        this.dragging = undefined;
        this.snap(this.index, undefined);
        this.rescale();
    };
    AyCarousel.prototype.translate = function (x, length, fn) {
        this.carousel.style['transition'] = 'transform';
        this.carousel.style['transitionTimingFunction'] = fn;
        this.carousel.style['transitionDuration'] = length + "ms";
        this.carousel.style['transform'] = "translate3d(" + x + "px,0px,0px)";
        this.rescale();
    };
    AyCarousel.prototype.percentVisible = function (card) {
        var cardRect = card.getBoundingClientRect();
        var cardWidth = card.offsetWidth;
        var frameWidth = window.innerWidth;
        if ((cardRect.left < 0 && cardRect.right < 0) || cardRect.left > frameWidth) {
            return 0;
        }
        else if (cardRect.left < 0) {
            return cardRect.right / cardWidth;
        }
        else if (cardRect.right > frameWidth) {
            return (frameWidth - cardRect.left) / cardWidth;
        }
        else {
            return 1;
        }
    };
    AyCarousel.prototype.rescale = function () {
        var from = Math.max(this.index - 2, 0);
        var to = Math.min(this.index + 2, this.cards.length - 1);
        for (var i = from; i <= to; i++) {
            var scaler = Math.max(this.percentVisible(this.cards[i]), 0.9);
            this.cards[i].style['transform'] = "scale(" + scaler + ")";
            this.cards[i].style['transitionTimingFunction'] = 'ease';
            this.cards[i].style['transitionDuration'] = "250ms";
        }
    };
    return AyCarousel;
}());
new AyCarousel(document.querySelector('#carousel-1'));
new AyCarousel(document.querySelector('#carousel-2'));
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvaW5kZXgudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7SUFrQkUsb0JBQVksUUFBc0I7UUFBbEMsaUJBbUJDO1FBbENELFdBQU0sR0FBWSxDQUFDLENBQUM7UUFDcEIsV0FBTSxHQUFZLENBQUMsQ0FBQztRQUtwQixjQUFTLEdBQVMsRUFBRSxDQUFDO1FBR3JCLFVBQUssR0FBWSxDQUFDLENBQUM7UUFFVixlQUFVLEdBQVksRUFBRSxDQUFDO1FBS2hDLEVBQUUsQ0FBQSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUM7WUFDWixJQUFJLENBQUMsUUFBUSxHQUFHLFFBQVEsQ0FBQztZQUV6QixJQUFJLENBQUMsUUFBUSxDQUFDLGdCQUFnQixDQUFDLFlBQVksRUFBRSxVQUFBLENBQUMsSUFBSSxPQUFBLEtBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEVBQW5CLENBQW1CLENBQUMsQ0FBQztZQUN2RSxJQUFJLENBQUMsUUFBUSxDQUFDLGdCQUFnQixDQUFDLFdBQVcsRUFBRSxVQUFBLENBQUMsSUFBSSxPQUFBLEtBQUksQ0FBQyxXQUFXLENBQUMsQ0FBQyxDQUFDLEVBQW5CLENBQW1CLENBQUMsQ0FBQztZQUV0RSxJQUFJLENBQUMsS0FBSyxHQUFRLElBQUksQ0FBQyxRQUFRLENBQUMsUUFBUSxDQUFDO1lBRXpDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxXQUFXLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsQ0FBQyxVQUFVLENBQUM7WUFFdEUsSUFBSSxDQUFDLFFBQVEsQ0FBQyxnQkFBZ0IsQ0FBQyxlQUFlLEVBQUU7Z0JBQzlDLEtBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNqQixDQUFDLENBQUMsQ0FBQztZQUNILElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUVmLFFBQVEsQ0FBQyxj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c0NvbnRlbnQiOlsiY2xhc3MgQXlDYXJvdXNlbCB7XG4gIGRyYWdnaW5nIDogYm9vbGVhbjtcbiAgb2Zmc2V0IDogYW55O1xuICBzdGFydFggOiBudW1iZXIgPSAwO1xuICBzdGFydFkgOiBudW1iZXIgPSAwO1xuICBkZWx0YSA6IGFueTtcbiAgcG9zaXRpb24gOiBhbnk7XG4gIGN1cnJlbnRUcmFuc2xhdGUgOiBudW1iZXI7XG4gIGxhc3RUcmFuc2xhdGUgOiBudW1iZXI7XG4gIGNhbGxiYWNrcyA6IGFueSA9IHt9O1xuICBjYXJkcyA6IEhUTUxFbGVtZW50W107XG4gIGNhcmRXaWR0aCA6IG51bWJlcjtcbiAgaW5kZXggOiBudW1iZXIgPSAwO1xuICBjYXJvdXNlbCA6IEhUTUxFbGVtZW50O1xuICByZWFkb25seSBTTkFQUElORVNTIDogbnVtYmVyID0gNDA7XG4gIHRvdGFsTW92ZSA6IGFueTtcbiAgbGFzdFBvcyA6IGFueTtcblxuICBjb25zdHJ1Y3RvcihjYXJvdXNlbCA6IEhUTUxFbGVtZW50KSB7XG4gICAgaWYoY2Fyb3VzZWwpIHtcbiAgICAgIHRoaXMuY2Fyb3VzZWwgPSBjYXJvdXNlbDtcbiAgICAgIFxuICAgICAgdGhpcy5jYXJvdXNlbC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaHN0YXJ0JywgZSA9PiB0aGlzLm9uZHJhZ3N0YXJ0KGUpKTtcbiAgICAgIHRoaXMuY2Fyb3VzZWwuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vkb3duJywgZSA9PiB0aGlzLm9uZHJhZ3N0YXJ0KGUpKTtcblxuICAgICAgdGhpcy5jYXJkcyA9IDxhbnk+dGhpcy5jYXJvdXNlbC5jaGlsZHJlbjtcblxuICAgICAgdGhpcy5jYXJkV2lkdGggPSB0aGlzLmNhcmRzWzBdLm9mZnNldFdpZHRoICsgdGhpcy5jYXJkc1swXS5vZmZzZXRMZWZ0O1xuXG4gICAgICB0aGlzLmNhcm91c2VsLmFkZEV2ZW50TGlzdGVuZXIoJ3RyYW5zaXRpb25lbmQnLCAoKSA9PiB7XG4gICAgICAgIHRoaXMucmVzY2FsZSgpO1xuICAgICAgfSk7XG4gICAgICB0aGlzLnJlc2NhbGUoKTtcbiAgICAgIFxuICAgICAgZG9jdW1lbnQuZ2V0RWxlbWVudEJ5SWQoJ3JpZ2h0JykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLnNuYXAuYmluZCh0aGlzLCB1bmRlZmluZWQsICdyaWdodCcpKTtcbiAgICAgIGRvY3VtZW50LmdldEVsZW1lbnRCeUlkKCdsZWZ0JykuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLnNuYXAuYmluZCh0aGlzLCB1bmRlZmluZWQsICdsZWZ0JykpOyBcbiAgICB9IFxuICB9XG5cbiAgb25kcmFnc3RhcnQoZSkge1xuICAgIGNvbnN0IHRvdWNoZXMgPSAgZS50b3VjaGVzID8gZS50b3VjaGVzWzBdIDogZTtcbiAgICBjb25zdCB7cGFnZVgsIHBhZ2VZfSA9IHRvdWNoZXM7XG5cbiAgICBjb25zdCBib3VuZGluZ1JlY3QgPSB0aGlzLmNhcmRzW3RoaXMuaW5kZXhdLmdldEJvdW5kaW5nQ2xpZW50UmVjdCgpO1xuICAgIHRoaXMub2Zmc2V0ID0ge1xuICAgICAgeDogcGFnZVggLSBib3VuZGluZ1JlY3QubGVmdCxcbiAgICAgIHk6IHBhZ2VZIC0gYm91bmRpbmdSZWN0LnRvcFxuICAgIH07XG5cbiAgICB0aGlzLmRlbHRhID0ge307XG5cbiAgICB0aGlzLnBvc2l0aW9uID0ge1xuICAgICAgeDogdGhpcy5jYXJvdXNlbC5vZmZzZXRMZWZ0LFxuICAgICAgeTogdGhpcy5jYXJvdXNlbC5vZmZzZXRUb3BcbiAgICB9O1xuXG4gICAgbGV0IGVkZ2VUb0NhcmREaXN0ID0gdGhpcy5jYXJkc1t0aGlzLmluZGV4XS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKS5sZWZ0O1xuICAgIHRoaXMubGFzdFRyYW5zbGF0ZSA9IHRoaXMuY2Fyb3VzZWwuZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkubGVmdCAtIGVkZ2VUb0NhcmREaXN0O1xuXG4gICAgdGhpcy50b3RhbE1vdmUgPSBcbiAgICB0aGlzLnN0YXJ0WCA9IHBhZ2VYO1xuICAgIHRoaXMuc3RhcnRZID0gcGFnZVk7XG5cbiAgICB0aGlzLmRyYWdnaW5nID0gdW5kZWZpbmVkO1xuXG4gICAgdGhpcy5jYWxsYmFja3Mub25tb3ZlID0gZSA9PiB0aGlzLm9uZHJhZ21vdmUoZSk7XG4gICAgdGhpcy5jYWxsYmFja3Mub25lbmQgPSBlID0+IHRoaXMub25kcmFnZW5kKGUpO1xuXG4gICAgdGhpcy50b3RhbE1vdmUgPSB7XG4gICAgICB4OiAwLFxuICAgICAgeTogMFxuICAgIH1cblxuICAgIHRoaXMubGFzdFBvcyA9IHtcbiAgICAgIHg6IDAsXG4gICAgICB5OiAwXG4gICAgfVxuICAgIFxuICAgIHRoaXMuY2Fyb3VzZWwuYWRkRXZlbnRMaXN0ZW5lcignbW91c2Vtb3ZlJywgdGhpcy5jYWxsYmFja3Mub25tb3ZlKTtcbiAgICB0aGlzLmNhcm91c2VsLmFkZEV2ZW50TGlzdGVuZXIoJ3RvdWNobW92ZScsIHRoaXMuY2FsbGJhY2tzLm9ubW92ZSk7XG4gICAgXG4gICAgdGhpcy5jYXJvdXNlbC5hZGRFdmVudExpc3RlbmVyKCd0b3VjaGVuZCcsIHRoaXMuY2FsbGJhY2tzLm9uZW5kKTtcbiAgICB0aGlzLmNhcm91c2VsLmFkZEV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCB0aGlzLmNhbGxiYWNrcy5vbmVuZCk7XG4gICAgdGhpcy5jYXJvdXNlbC5hZGRFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgdGhpcy5jYWxsYmFja3Mub25lbmQpO1xuICB9XG5cbiAgb25kcmFnbW92ZShlKSB7XG4gICAgY29uc3QgdG91Y2hlcyA9ICBlLnRvdWNoZXMgPyBlLnRvdWNoZXNbMF0gOiBlO1xuICAgIGNvbnN0IHtwYWdlWCwgcGFnZVl9ID0gdG91Y2hlcztcbiAgICBjb25zb2xlLmxvZyhlKTtcbiAgICBjb25zdCBtb3ZlID0ge1xuICAgICAgeDogdGhpcy5zdGFydFggLSBwYWdlWCxcbiAgICAgIHk6IHRoaXMuc3RhcnRZIC0gcGFnZVlcbiAgICB9XG5cbiAgICAvLyBLZWVwIHRyYWNrIG9mIHRoZSB0b3RhbCBkaXN0YW5jZSBtb3ZlZCByaWdodC9sZWZ0IGluIHRoZSBtb3ZlXG4gICAgdGhpcy50b3RhbE1vdmUueCArPSBNYXRoLmFicyhtb3ZlLnggLSB0aGlzLmxhc3RQb3MueCk7XG4gICAgdGhpcy50b3RhbE1vdmUueSArPSBNYXRoLmFicyhtb3ZlLnkgLSB0aGlzLmxhc3RQb3MueSk7XG4gICAgXG4gICAgdGhpcy5sYXN0UG9zID0ge1xuICAgICAgeDogbW92ZS54LFxuICAgICAgeTogbW92ZS55XG4gICAgfTtcblxuICAgIGlmKHRoaXMudG90YWxNb3ZlLnggPCAxMCAmJiB0aGlzLnRvdGFsTW92ZS55IDwgMTApIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBpZih0aGlzLnRvdGFsTW92ZS54ID4gdGhpcy50b3RhbE1vdmUueSkge1xuICAgICAgZS5wcmV2ZW50RGVmYXVsdCgpO1xuICAgICAgdGhpcy5kZWx0YSA9IHtcbiAgICAgICAgeDogcGFnZVggLSB0aGlzLnBvc2l0aW9uLngsXG4gICAgICAgIHk6IHBhZ2VZIC0gdGhpcy5wb3NpdGlvbi55XG4gICAgICB9O1xuICAgICAgY29uc3QgY3VycmVudFRyYW5zbGF0ZSA9IHRoaXMuZGVsdGEueCArIHRoaXMubGFzdFRyYW5zbGF0ZSAtIHRoaXMub2Zmc2V0Lng7XG5cbiAgICAgIHRoaXMudHJhbnNsYXRlKGN1cnJlbnRUcmFuc2xhdGUsIDAsIG51bGwpO1xuXG4gICAgICBsZXQgY2FyZE1pZHBvaW50ID0gKHRoaXMuY2FyZHNbdGhpcy5pbmRleF0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkubGVmdCArIHRoaXMuY2FyZHNbdGhpcy5pbmRleF0uZ2V0Qm91bmRpbmdDbGllbnRSZWN0KCkucmlnaHQpIC8gMjtcbiAgICAgIGxldCB2aWV3cG9ydFdpZHRoID0gd2luZG93LmlubmVyV2lkdGg7XG5cbiAgICAgIGlmKGNhcmRNaWRwb2ludCA8PSAwICsgdGhpcy5TTkFQUElORVNTKSB7XG4gICAgICAgIC8vIElmIGNhcmQgbWlkcG9pbnQgaXMgY2xvc2UgZW5vdWdoIHRvIGxlZnQgZWRnZSwgZGVjcmVtZW50IGluZGV4XG4gICAgICAgIHRoaXMuaW5kZXggPSBNYXRoLm1pbih0aGlzLmluZGV4KzEsIHRoaXMuY2FyZHMubGVuZ3RoLTEpO1xuICAgICAgfSBlbHNlIGlmKGNhcmRNaWRwb2ludCA+IHZpZXdwb3J0V2lkdGggLSB0aGlzLlNOQVBQSU5FU1MpIHtcbiAgICAgICAgLy8gSWYgY2FyZCBtaWRwb2ludCBpcyBjbG9zZSBlbm91Z2ggdG8gcmlnaHQgZWRnZSwgaW5jcmVtZW50IGluZGV4XG4gICAgICAgIHRoaXMuaW5kZXggPSBNYXRoLm1heCh0aGlzLmluZGV4LTEsIDApO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHNuYXAobmV4dEluZGV4PyA6IG51bWJlciwgZGlyZWN0aW9uPyA6IHN0cmluZykge1xuICAgIGlmKGRpcmVjdGlvbikge1xuICAgICAgZGlyZWN0aW9uID09ICdyaWdodCcgPyBuZXh0SW5kZXggPSB0aGlzLmluZGV4KzEgOiBuZXh0SW5kZXggPSB0aGlzLmluZGV4LTE7XG4gICAgfVxuICAgIG5leHRJbmRleCA9IE1hdGgubWluKE1hdGgubWF4KG5leHRJbmRleCwgMCksIHRoaXMuY2FyZHMubGVuZ3RoIC0gMSk7XG4gICAgdGhpcy5pbmRleCA9IG5leHRJbmRleDtcblxuICAgIGNvbnN0IGNvbnRhaW5lciA9IHRoaXMuY2Fyb3VzZWwucGFyZW50RWxlbWVudDtcbiAgICBjb25zdCBjb250YWluZXJXaWR0aCA9IGNvbnRhaW5lci5vZmZzZXRXaWR0aDtcbiAgICBjb25zdCBjb250YWluZXJNYXJnaW4gPSBwYXJzZUludCh3aW5kb3cuZ2V0Q29tcHV0ZWRTdHlsZShjb250YWluZXIpLm1hcmdpbkxlZnQsIDApO1xuICBcbiAgICBjb25zdCBjYXJkID0gdGhpcy5jYXJkc1tuZXh0SW5kZXhdO1xuXG4gICAgLy8gV2lkdGggb2YgY29udGFpbmVyIC0gV2lkdGggb2YgY2FyZCA9IEFsbCB0aGUgZXh0cmEgc3BhY2VcbiAgICAvLyBEaXZpZGUgdGhpcyBieSAyIHRvIGdldCBkZXNpcmVkIGRpc3RhbmNlIGZyb20gZWRnZSBvbiBlaXRoZXIgc2lkZSBvZiBjYXJkXG4gICAgY29uc3QgZWRnZVRvQ2FyZERpc3QgPSAoY29udGFpbmVyV2lkdGggLSBjYXJkLm9mZnNldFdpZHRoKS8yO1xuICAgIFxuICAgIC8vIFRyYW5zbGF0aW5nIHRvIHRoZSBsZWZ0IG9mIHRoZSBkZXNpcmVkIGNhcmQsIG1pbnVzIG91ciBkZXNpcmVkIGVkZ2UgZGlzdFxuICAgIC8vIE11bHRpcGxpZWQgYnkgLTEgYmVjYXVzZSB3ZSBhcmUgdHJhbnNsYXRpbmcgdG8gdGhlIHJpZ2h0XG4gICAgY29uc3QgbmV4dE9mZnNldCA9IE1hdGgubWluKChjYXJkLm9mZnNldExlZnQgLSBlZGdlVG9DYXJkRGlzdCArIGNvbnRhaW5lck1hcmdpbikgKiAtMSwgMCk7XG5cbiAgICAvLyBodHRwOi8vZWFzaW5ncy5uZXQvI2Vhc2VJbk91dENpcmNcbiAgICBjb25zdCBlYXNlID0gJ2N1YmljLWJlemllcigwLjc4NSwgMC4xMzUsIDAuMTUsIDAuODYpJztcbiAgICB0aGlzLnRyYW5zbGF0ZShuZXh0T2Zmc2V0LCAyNTAsIGVhc2UpO1xuICB9XG5cbiAgb25kcmFnZW5kKGUpIHtcbiAgICB0aGlzLnBvc2l0aW9uID0ge1xuICAgICAgeDogZS50YXJnZXQub2Zmc2V0TGVmdCxcbiAgICAgIHk6IGUudGFyZ2V0Lm9mZnNldFRvcFxuICAgIH07XG5cbiAgICB0aGlzLnRvdGFsTW92ZSA9IHtcbiAgICAgIHg6IDAsXG4gICAgICB5OiAwXG4gICAgfTtcbiAgICB0aGlzLmNhcm91c2VsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNlbW92ZScsIHRoaXMuY2FsbGJhY2tzLm9ubW92ZSk7XG4gICAgdGhpcy5jYXJvdXNlbC5yZW1vdmVFdmVudExpc3RlbmVyKCd0b3VjaG1vdmUnLCB0aGlzLmNhbGxiYWNrcy5vbm1vdmUpO1xuICAgIFxuICAgIHRoaXMuY2Fyb3VzZWwucmVtb3ZlRXZlbnRMaXN0ZW5lcigndG91Y2hlbmQnLHRoaXMuY2FsbGJhY2tzLm9uZW5kKTtcbiAgICB0aGlzLmNhcm91c2VsLnJlbW92ZUV2ZW50TGlzdGVuZXIoJ21vdXNldXAnLCB0aGlzLmNhbGxiYWNrcy5vbmVuZCk7XG4gICAgdGhpcy5jYXJvdXNlbC5yZW1vdmVFdmVudExpc3RlbmVyKCdtb3VzZWxlYXZlJywgdGhpcy5jYWxsYmFja3Mub25lbmQpO1xuXG4gICAgdGhpcy5kcmFnZ2luZyA9IHVuZGVmaW5lZDtcblxuICAgIC8vIFNuYXAgdG8gaW5kZXgsIHdoaWNoIGhhcyBiZWVuIHNldCB0byB0aGUgbmVhcmVzdCBjYXJkXG4gICAgdGhpcy5zbmFwKHRoaXMuaW5kZXgsIHVuZGVmaW5lZCk7XG5cbiAgICB0aGlzLnJlc2NhbGUoKTtcbiAgfVxuXG4gIHRyYW5zbGF0ZSh4IDogbnVtYmVyLCBsZW5ndGggOiBudW1iZXIsIGZuIDogc3RyaW5nKSB7XG4gICAgdGhpcy5jYXJvdXNlbC5zdHlsZVsndHJhbnNpdGlvbiddID0gJ3RyYW5zZm9ybSc7XG4gICAgdGhpcy5jYXJvdXNlbC5zdHlsZVsndHJhbnNpdGlvblRpbWluZ0Z1bmN0aW9uJ10gPSBmbjtcbiAgICB0aGlzLmNhcm91c2VsLnN0eWxlWyd0cmFuc2l0aW9uRHVyYXRpb24nXSA9IGAke2xlbmd0aH1tc2A7XG4gICAgdGhpcy5jYXJvdXNlbC5zdHlsZVsndHJhbnNmb3JtJ10gPSBgdHJhbnNsYXRlM2QoJHt4fXB4LDBweCwwcHgpYDtcblxuICAgIHRoaXMucmVzY2FsZSgpO1xuICB9XG5cbiAgcGVyY2VudFZpc2libGUoY2FyZCA6IEhUTUxFbGVtZW50KSB7XG4gICAgbGV0IGNhcmRSZWN0ID0gY2FyZC5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKTtcbiAgICBsZXQgY2FyZFdpZHRoID0gY2FyZC5vZmZzZXRXaWR0aDtcbiAgICBsZXQgZnJhbWVXaWR0aCA9IHdpbmRvdy5pbm5lcldpZHRoO1xuXG4gICAgaWYoKGNhcmRSZWN0LmxlZnQgPCAwICYmIGNhcmRSZWN0LnJpZ2h0IDwgMCkgfHwgY2FyZFJlY3QubGVmdCA+IGZyYW1lV2lkdGgpIHtcbiAgICAgIHJldHVybiAwO1xuICAgIH0gZWxzZSBpZihjYXJkUmVjdC5sZWZ0IDwgMCkge1xuICAgICAgcmV0dXJuIGNhcmRSZWN0LnJpZ2h0L2NhcmRXaWR0aDtcbiAgICB9IGVsc2UgaWYoY2FyZFJlY3QucmlnaHQgPiBmcmFtZVdpZHRoKSB7XG4gICAgICByZXR1cm4gKGZyYW1lV2lkdGggLSBjYXJkUmVjdC5sZWZ0KS9jYXJkV2lkdGg7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiAxO1xuICAgIH1cbiAgfVxuXG4gIHJlc2NhbGUoKSB7XG4gICAgLy8gUmVzY2FsZSBjdXJyZW50IGNhcmQgYW5kIDIgY2FyZHMgaW4gZWl0aGVyIGRpcmVjdGlvblxuICAgIGNvbnN0IGZyb20gPSBNYXRoLm1heCh0aGlzLmluZGV4LTIgLDApO1xuICAgIGNvbnN0IHRvID0gTWF0aC5taW4odGhpcy5pbmRleCsyLCB0aGlzLmNhcmRzLmxlbmd0aC0xKVxuXG4gICAgZm9yKGxldCBpID0gZnJvbTsgaTw9dG87IGkrKykge1xuICAgICAgbGV0IHNjYWxlciA9IE1hdGgubWF4KHRoaXMucGVyY2VudFZpc2libGUodGhpcy5jYXJkc1tpXSksIDAuOSk7XG5cbiAgICAgIHRoaXMuY2FyZHNbaV0uc3R5bGVbJ3RyYW5zZm9ybSddID0gYHNjYWxlKCR7c2NhbGVyfSlgO1xuICAgICAgdGhpcy5jYXJkc1tpXS5zdHlsZVsndHJhbnNpdGlvblRpbWluZ0Z1bmN0aW9uJ10gPSAnZWFzZSc7XG4gICAgICB0aGlzLmNhcmRzW2ldLnN0eWxlWyd0cmFuc2l0aW9uRHVyYXRpb24nXSA9IGAyNTBtc2A7XG4gICAgfVxuICB9XG59XG5uZXcgQXlDYXJvdXNlbCg8SFRNTEVsZW1lbnQ+ZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2Nhcm91c2VsLTEnKSk7XG5uZXcgQXlDYXJvdXNlbCg8SFRNTEVsZW1lbnQ+ZG9jdW1lbnQucXVlcnlTZWxlY3RvcignI2Nhcm91c2VsLTInKSk7XG4iXX0=